name: Environment Suite

on:
  push:
    branches:
      - master
  workflow_dispatch:

env:
  VERBOSE: true
  ENVIRONMENT_UPSTREAM: timberio/ci_image:${{ github.sha }}
  CI: true

jobs:
  publish-new-environment:
    runs-on: ubuntu-latest
    env:
      ENVIRONMENT_AUTOBUILD: true
    steps:
      - run: docker login -u ${{ secrets.DOCKER_USER }} -p ${{ secrets.DOCKER_PASSWORD }}
      - uses: actions/checkout@v2
      - run: make ci-sweep
      - name: prepare environment
        run: make environment-prepare
      - name: push image
        if: github.event_name != 'workflow_dispatch'
        run: docker push timberio/ci_image:${{ github.sha }}
